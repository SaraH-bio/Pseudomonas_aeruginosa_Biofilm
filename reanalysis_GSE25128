
library(GEOquery)

# Download the dataset (this retrieves the Series Matrix file by default)
gse <- getGEO("GSE25128", GSEMatrix = TRUE)

length(gse)         
names(gse)          
gse[[1]]           
expr_data <- exprs(gse[[1]])
head(expr_data)

# phenodata
pheno_data <- pData(gse[[1]])
head(pheno_data)

expr_data = as.data.frame(expr_data)

# Annotation
GSE25128.annotation <- read.delim(" .tsv")

# Merge by ID
merged_data <- merge(expr_data, GSE25128.annotation, by = "ID")

# View result
head(merged_data)

# Remove rows where gene.symbol is NA or empty string
data <- merged_data[merged_data$Gene.symbol != "" & !is.na(merged_data$Gene.symbol), ]

# View result
head(data)

# make numeric
data = apply(data, 2, as.numeric)
mode(data)

# Aggregation
data.agg = aggregate(data, by = list(data2$Gene.symbol), FUN = mean)
dim(data.agg)

# remove low varience rows
varRow = apply(data.agg, 1, var, na.rm =T)
constRow = (varRow == 0 | is.na(varRow))
sum(constRow)

# subset  QSbiofilm_QSplanktonic
pheno_QSbiofilm_QSplanktonic <- pheno_data[pheno_data$status %in% c("BiofilmQS", "PlanktonicQS"), ]
expr_QSbiofilm_QSplanktonic <- data.agg[, rownames(pheno_QSbiofilm_QSplanktonic)]

# limma DEGs
# Create design matrix
design <- model.matrix(~ 0 + pheno_QSbiofilm_QSplanktonic$status)
colnames(design) <- c("BiofilmQS", "PlanktonicQS")

# Fit the linear model
fit <- limma::lmFit(expr_QSbiofilm_QSplanktonic, design)

# Define contrast: BiofilmQS_vs_PlanktonicQS
contrast_matrix <- limma::makeContrasts(BiofilmQS_vs_PlanktonicQS  = BiofilmQS - PlanktonicQS , levels = design)

# Apply contrast to the model
fit2 <- limma::contrasts.fit(fit, contrast_matrix)

# Apply empirical Bayes moderation
fit2 <- limma::eBayes(fit2)

# Extract top DEGs (sorted by adjusted p-value)
top_table <- limma::topTable(fit2, adjust.method = "fdr", number = Inf, sort.by = "P")

# View top differentially expressed genes
head(top_table)

# volcano plot
# Assuming your DEGs data frame is 'top_table'
top_table$diffexpressed = "NO"  
top_table$diffexpressed[top_table$logFC > 1 & top_table$P.Value < 0.05] = "UP"  
top_table$diffexpressed[top_table$logFC < -1 & top_table$P.Value < 0.05] = "DOWN"  

top_table$delabel = NA  
top_table$delabel[top_table$diffexpressed != "NO"] = rownames(top_table)[top_table$diffexpressed != "NO"] 


# Create the base plot
p = ggplot(data = top_table, aes(x = logFC, y = -log10(P.Value), col = diffexpressed)) +
  geom_point() +
  theme_minimal() +
  geom_vline(xintercept = c(-1, 1), col = "red") +  
  geom_hline(yintercept = -log10(0.05), col = "red") +  
  scale_color_manual(values = c("DOWN" = "red", "UP" = "purple", "NO" = "yellow"))  

# Add gene labels for significant genes (avoiding overlap)
p = p + geom_text(aes(label = delabel), vjust = 1.5, hjust = 1.5, size = 3, check_overlap = TRUE)

# Display the plot
print(p)

# Filter for DEGs based on p-value < 0.05 and absolute logFC > 1
deg_filtered = top_table[top_table$P.Value < 0.05 & abs(top_table$logFC) > 1, ]

upDEGs = deg_filtered %>%filter(P.Value < 0.05 & logFC >1) # UP in biofilm
downDEGs = deg_filtered %>%filter(P.Value < 0.05 & logFC < -1)  # DOWN in biofilm
